#!/usr/bin/env bash

git rm -r --cached .

read -r -p "Commit Message: " input

git add .
echo "APP com CD/CI implementado... push na master irá para publicação e produção..."
git commit -m "$input"

git push origin master

# Determine next semantic version
TAG_FILE=".giti_tag"
if [ -f "$TAG_FILE" ] && [ -s "$TAG_FILE" ]; then
  LAST_TAG=$(tail -n1 "$TAG_FILE")
  # Strip leading 'v'
  VERSION=${LAST_TAG#v}
  IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
  PATCH=$((PATCH + 1))
  NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
else
  NEW_TAG="v1.0.0"
fi

echo "Creating semantic tag $NEW_TAG"
git tag -a "$NEW_TAG" -m "Automated release $NEW_TAG"
git push origin "$NEW_TAG"

# Record the new tag
echo "$NEW_TAG" >> "$TAG_FILE"

exit 0
